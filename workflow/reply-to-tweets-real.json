{
  "version": "1.0",
  "name": "Reply to Tweets (Production)",
  "description": "Search tweets by query, rank by engagement, generate AI-powered replies, and post them to Twitter with duplicate prevention",
  "trigger": {
    "type": "cron",
    "config": {
      "schedule": "0 */2 * * *",
      "timezone": "UTC"
    }
  },
  "config": {
    "steps": [
      {
        "id": "search-tweets",
        "module": "external-apis.rapidapi-twitter.searchTwitter",
        "inputs": {
          "params": {
            "query": "AI tools OR TypeScript tips OR open source",
            "apiKey": "{{credential.rapidapi_api_key}}",
            "count": 20,
            "category": "Latest",
            "minimumLikesCount": 5,
            "minimumRetweetsCount": 2,
            "removePostsWithLinks": true,
            "removePostsWithMedia": true
          }
        },
        "outputAs": "searchResults",
        "note": "Search for tweets matching criteria with engagement filters"
      },
      {
        "id": "extract-tweets",
        "module": "utilities.javascript.execute",
        "inputs": {
          "options": {
            "code": "const tweets = searchResults?.results || []; return tweets.map(t => ({ id: t.tweet_id, text: t.text, author: t.user_screen_name || 'unknown', authorName: t.user_name || null, likes: t.likes || 0, retweets: t.retweets || 0, replies: t.replies || 0, views: t.views || 0, created_at: t.created_at || new Date().toISOString() }));",
            "context": {
              "searchResults": "{{searchResults}}"
            }
          }
        },
        "outputAs": "tweets",
        "note": "Transform tweets into standardized format"
      },
      {
        "id": "extract-tweet-ids",
        "module": "utilities.javascript.execute",
        "inputs": {
          "options": {
            "code": "return tweets.map(t => t.id);",
            "context": {
              "tweets": "{{tweets}}"
            }
          }
        },
        "outputAs": "tweetIds",
        "note": "Extract all tweet IDs for duplicate checking"
      },
      {
        "id": "check-already-replied",
        "module": "data.drizzle-utils.queryWhereIn",
        "inputs": {
          "params": {
            "tableName": "tweet_replies",
            "column": "original_tweet_id",
            "values": "{{tweetIds}}",
            "selectColumn": "original_tweet_id"
          }
        },
        "outputAs": "repliedTweetIds",
        "note": "Query database for tweets we've already replied to"
      },
      {
        "id": "filter-unreplied-tweets",
        "module": "utilities.deduplication.excludeByIds",
        "inputs": {
          "params": {
            "items": "{{tweets}}",
            "excludeIds": "{{repliedTweetIds}}",
            "idField": "id"
          }
        },
        "outputAs": "unrepliedTweets",
        "note": "Filter out already-replied tweets to prevent duplicates"
      },
      {
        "id": "rank-by-engagement",
        "module": "utilities.scoring.rankByWeightedScore",
        "inputs": {
          "params": {
            "items": "{{unrepliedTweets}}",
            "scoreFields": [
              { "field": "likes", "weight": 1 },
              { "field": "retweets", "weight": 2 },
              { "field": "replies", "weight": 1.5 },
              { "field": "views", "weight": 0.001 }
            ],
            "tieBreaker": { "field": "created_at", "order": "desc" },
            "similarityThreshold": 0.1
          }
        },
        "outputAs": "rankedTweets",
        "note": "Rank by engagement with recency tie-breaking (matches TypeScript logic)"
      },
      {
        "id": "select-top-tweet",
        "module": "utilities.scoring.selectTop",
        "inputs": {
          "params": {
            "items": "{{rankedTweets}}",
            "count": 1
          }
        },
        "outputAs": "topTweet",
        "note": "Select the best tweet to reply to"
      },
      {
        "id": "prepare-ai-prompt",
        "module": "utilities.javascript.execute",
        "inputs": {
          "options": {
            "code": "if (!topTweet) { throw new Error('No suitable tweet found to reply to'); } const systemPrompt = 'Generate a helpful, engaging, and authentic reply to this tweet. Be conversational and add value. Keep it under 280 characters.'; return { tweetId: topTweet.id, tweetText: topTweet.text, author: topTweet.author, authorName: topTweet.authorName, engagement: topTweet._score || 0, prompt: `${systemPrompt}\\n\\nTweet: ${topTweet.text}` };",
            "context": {
              "topTweet": "{{topTweet}}"
            }
          }
        },
        "outputAs": "replyPrompt",
        "note": "Build AI prompt with system instructions"
      },
      {
        "id": "generate-reply",
        "module": "ai.ai-sdk.generateText",
        "inputs": {
          "options": {
            "prompt": "{{replyPrompt.prompt}}",
            "model": "gpt-4o-mini",
            "provider": "openai",
            "maxTokens": 100,
            "temperature": 0.8,
            "apiKey": "{{credential.openai_api_key}}"
          }
        },
        "outputAs": "aiReply",
        "note": "Generate AI-powered reply"
      },
      {
        "id": "post-reply",
        "module": "social.twitter-oauth.replyToTweet",
        "inputs": {
          "params": {
            "tweetId": "{{replyPrompt.tweetId}}",
            "text": "{{aiReply.content}}",
            "accessToken": "{{credential.twitter_oauth}}"
          }
        },
        "outputAs": "postedReply",
        "note": "Post reply to Twitter"
      },
      {
        "id": "prepare-database-record",
        "module": "utilities.javascript.execute",
        "inputs": {
          "options": {
            "code": "return { original_tweet_id: topTweet.id, original_tweet_text: topTweet.text, original_tweet_author: topTweet.author, original_tweet_author_name: topTweet.authorName, original_tweet_likes: topTweet.likes || 0, original_tweet_retweets: topTweet.retweets || 0, original_tweet_replies: topTweet.replies || 0, original_tweet_views: topTweet.views || 0, our_reply_text: aiReply.content, our_reply_tweet_id: postedReply?.data?.id || postedReply?.id || null, status: 'posted', replied_at: new Date() };",
            "context": {
              "topTweet": "{{topTweet}}",
              "aiReply": "{{aiReply}}",
              "postedReply": "{{postedReply}}"
            }
          }
        },
        "outputAs": "replyRecord",
        "note": "Prepare record for database persistence"
      },
      {
        "id": "save-to-database",
        "module": "data.drizzle-utils.insertRecord",
        "inputs": {
          "params": {
            "tableName": "tweet_replies",
            "data": "{{replyRecord}}"
          }
        },
        "outputAs": "savedRecord",
        "note": "Save reply to database for duplicate tracking"
      },
      {
        "id": "build-final-result",
        "module": "utilities.javascript.execute",
        "inputs": {
          "options": {
            "code": "return [{ tweetId: replyPrompt.tweetId, originalTweet: replyPrompt.tweetText, author: replyPrompt.author, engagement: replyPrompt.engagement, generatedReply: aiReply.content, postedReplyId: postedReply?.data?.id || postedReply?.id || 'Posted', status: 'Success', savedToDatabaseId: savedRecord?.id || null }];",
            "context": {
              "replyPrompt": "{{replyPrompt}}",
              "aiReply": "{{aiReply}}",
              "postedReply": "{{postedReply}}",
              "savedRecord": "{{savedRecord}}"
            }
          }
        },
        "outputAs": "finalResult",
        "note": "Build final output for display"
      }
    ],
    "returnValue": "{{finalResult}}",
    "outputDisplay": {
      "type": "table",
      "columns": [
        {
          "key": "tweetId",
          "label": "Tweet ID",
          "type": "text"
        },
        {
          "key": "author",
          "label": "Author",
          "type": "text"
        },
        {
          "key": "originalTweet",
          "label": "Original Tweet",
          "type": "text"
        },
        {
          "key": "engagement",
          "label": "Engagement Score",
          "type": "number"
        },
        {
          "key": "generatedReply",
          "label": "Our Reply",
          "type": "text"
        },
        {
          "key": "postedReplyId",
          "label": "Reply ID",
          "type": "text"
        },
        {
          "key": "status",
          "label": "Status",
          "type": "text"
        }
      ]
    }
  },
  "metadata": {
    "author": "b0t Workflow Generator",
    "tags": ["twitter", "social-media", "ai", "automation", "engagement", "deduplication"],
    "category": "social",
    "requiresCredentials": ["rapidapi", "twitter_oauth", "openai"],
    "notes": "Production workflow with duplicate prevention via database tracking. Uses generic, reusable modules: data.drizzle-utils for database operations, utilities.scoring for engagement ranking with recency tie-breaking, and utilities.deduplication for filtering. All credentials from database. Matches TypeScript workflow functionality."
  }
}
